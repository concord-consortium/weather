<!DOCTYPE html>
<html>
<head>
  <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
  <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.min.js"></script>
  <script src="nutella_lib.js" type="text/javascript"></script>

  <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.9.2/themes/cupertino/jquery-ui.css" />
 
  <style type="text/css">

    .inactiveLink {
       pointer-events: none;
       cursor: default;
    }


    li {
      font: 200 20px/1.5 Helvetica, Verdana, sans-serif;
      border-bottom: 1px solid #ccc;
      padding:5px 5px 5px 5px;
      background-color:white;
      list-style-type: none;
    }
    ul {
       background-color:white;
   }
/*    li:last-child {
      border: none;
    }
*/
    li  a {
      text-decoration: none;
      color: white;

      -webkit-transition: font-size 0.3s ease, background-color 0.3s ease;
      -moz-transition: font-size 0.3s ease, background-color 0.3s ease;
      -o-transition: font-size 0.3s ease, background-color 0.3s ease;
      -ms-transition: font-size 0.3s ease, background-color 0.3s ease;
      transition: font-size 0.3s ease, background-color 0.3s ease;
      /*display: block;*/
    }

    #mydiv {
      text-align: center;

    }

    button {
      font-size: 20px;
    }

    li  a:hover {
      font-size: 30px;
      /*background: white;*/
    }

    #portals {
      /*list-style: none;*/
      padding-left: 0;
    }
 
    #portals .sort-handle {
      display: none;
    }
 
    #portals .ui-selected .sort-handle
     {
      display: inline;
      padding: 0 0.5em;
      cursor: pointer;
    }

    #activities {
      /*list-style: none;*/
      padding-left: 0;
    }
 
    #activities .sort-handle {
      display: none;
    }
 
    #activities .ui-selected .sort-handle
     {
      display: inline;
      padding: 0 0.5em;
      cursor: pointer;
    }

    #resources {
      /*list-style: none;*/
      padding-left: 0;
    }
 
    #resources .sort-handle {
      display: none;
    }
 
    #resources .ui-selected .sort-handle
     {
      display: inline;
      padding: 0 0.5em;
      cursor: pointer;
    }

    .header {font-size:25px; font-family:Helvetica;}


    li.ui-selected {
      background-color: white;
      color: black;
      font-weight: bold;
      background-image: none;
    }
    li.ui-selecting {
      background-color: white;
      color: red;
      background-image: none;
    }
 
  </style>
    <script>
    $(function() {

      var query_parameters = NUTELLA.parseURLParameters();
      var nutella = NUTELLA.init(query_parameters.broker, query_parameters.app_id, query_parameters.run_id, NUTELLA.parseComponentId());
      console.log('got here');
      nutella.net.request('get_portals',{},function(parm_portals,from){ console.log(parm_portals);
        var portals = parm_portals.portalList;
        var topPortalID = parm_portals.topID;
        console.log(topPortalID);
        console.log(portals);
        nutella.net.request('get_activities',{},function(parm_activities,from){console.log(parm_activities);
          var activities = parm_activities.activityList;
          var topActivityID = parm_activities.topID;
          console.log(topActivityID);
          console.log(activities);

          nutella.net.request('get_resources',{},function(parm_resources,from){
            var resources = parm_resources.resourceList;
            var topResourceID = parm_resources.topID;
            nutella.net.request('get_distribution',{},function(parm_distribution,from){
              var distribution = parm_distribution;
              for(var i=0; i<portals.length;i++) 
                $('#portals').append(' <li class="ui-widget-content" value="' + portals[i].portalID + '"><span class="sort-handle">&#9776;</span><a href="#">' + portals[i].name + '</a></li> ');
              for(var i=0; i<activities.length;i++) 
                $('#activities').append('<li class="ui-widget-content" value="' + activities[i].activityID + '"><span class="sort-handle">&#9776;</span><a href="#">' + activities[i].name + '</a></li> ');
              console.log('got to end');
              for(var i=0; i<resources.length;i++) 
                $('#resources').append('<li class="ui-widget-content" value="' + resources[i].resourceID + '"><span class="sort-handle">&#9776;</span><a href="#">' + resources[i].name + '</a></li> ');

              var current_portalID = -1;
              var current_activityID = -1;
              setupList("portals");
              setupList("activities");
              setupList("resources");
              


              $( "#portals" ).on( "selectableselected", function( event, ui ) {
                var list = event.target;
                current_portalID = $( "#portals" ).children("li.ui-selected")[0].value; 
                console.log($( "#portals" ).children("li.ui-selected"));
                console.log($( "#portals" ).children("li.ui-selected")[0]);
                console.log($( "#portals" ).children("li.ui-selected")[0].value);
                var name = $( "#portals" ).children("li.ui-selected")[0].innerHTML.match(/<a.*a>/g)[0];
                name = name.match(/>.*</g)[0];
                name = name.substr(1);
                name = name.substr(0,name.length-1);  
                console.log(name);
                document.getElementById('portalName').value = name;
                document.getElementById('portalName').select();

                loadResources();

              });

              $( "#activities" ).on( "selectableselected", function( event, ui ) {
                var list = event.target;
                current_activityID = $( "#activities" ).children("li.ui-selected")[0].value; 
                console.log($( "#activities" ).children("li.ui-selected"));
                console.log($( "#activities" ).children("li.ui-selected").value);
                console.log($( "#activities" ).children("li.ui-selected")[0]);
                console.log($( "#activities" ).children("li.ui-selected")[0].value);
                var name = $( "#activities" ).children("li.ui-selected")[0].innerHTML.match(/<a.*a>/g)[0];
                name = name.match(/>.*</g)[0];
                name = name.substr(1);
                name = name.substr(0,name.length-1);  
                console.log(name);
                document.getElementById('activityName').value = name;
                document.getElementById('activityName').select();

                loadResources();

              });

              $( "#resources" ).on( "selectableselected", function( event, ui ) { 
                // if ($( "#resources" ).children("li.ui-selected")[0].value == )
                save();
              });


              $('#addPortal').on("click",function(){
                var ID = ++topPortalID; 
                var name = "untitled";
                portals.push({portalID: ID, name: name});
                $('#portals').append(' <li class="ui-widget-content" value="' + ID + '"><span class="sort-handle">&#9776;</span><a href="#">' + name + '</a></li> ');
                nutella.net.publish('set_portals',{topID: topPortalID, portalList: portals});
              });

              $('#addActivity').on("click",function(){
                var ID = ++topActivityID;
                var name = "untitled";
                activities.push({activityID: ID, name: name});
                $('#activities').append(' <li class="ui-widget-content" value="' + ID + '"><span class="sort-handle">&#9776;</span><a href="#">' + name + '</a></li> ');
                nutella.net.publish('set_activities',{topID: topActivityID, activityList: activities});
              });



              $('#deletePortal').on("click",function(){
                var ID = current_portalID; //$('#portals li.ui-selected')[0].value;
                $('#portals li.ui-selected').remove();
                document.getElementById('portalName').value = '';
                portals = portals.filter(function(arg){
                  return (arg.portalID != ID);
                });
                console.log(portals);
                nutella.net.publish('set_portals',{topID: topPortalID, portalList: portals});
                distribution = distribution.filter(function(arg){
                  return (arg.portalID != ID);
                });
                nutella.net.publish('set_distribution',distribution);
                current_portalID = -1;
                // should add warning dialog
                // should clean out distribution entries with this portal
              });


              $('#deleteActivity').on("click",function(){
                var ID = current_activityID; //$('#portals li.ui-selected')[0].value;
                console.log(ID);
                $('#activities li.ui-selected').remove();
                document.getElementById('activityName').value = '';
                activities = activities.filter(function(arg){
                  return (arg.activityID != ID);
                });
                console.log(activities);
                nutella.net.publish('set_activities',{topID: topActivityID, activityList: activities});
                distribution = distribution.filter(function(arg){
                  return (arg.activityID != ID);
                });
                nutella.net.publish('set_distribution',distribution);
                current_activityID = -1;
                // should add warning dialog
                // should clean out distribution entries with this portal
              });


              $("#portalName").on('keyup', function (e) { console.log('current_portalID:   ' + current_portalID);
                  if (current_portalID < 0) {document.getElementById('portalName').value = ''; return;}
                  if (e.keyCode == 13) {
                    var name = document.getElementById('portalName').value; 
                    $('#portals li.ui-selected a')[0].innerHTML = name; 
                    console.log($('#portals li.ui-selected')[0].value);
                    for (var i=0; i<portals.length; i++){ console.log (portals[i]);
                      if (portals[i].portalID == current_portalID) {portals[i].name = name; break;}
                    }
                    console.log(portals);
                    nutella.net.publish('set_portals',{topID: topPortalID, portalList: portals});
                  }
              });

              $("#activityName").on('keyup', function (e) { console.log('current_activityID:   ' + current_activityID);
                  if (current_activityID < 0) {document.getElementById('activityName').value = ''; return;}
                  if (e.keyCode == 13) {
                    var name = document.getElementById('activityName').value; 
                    $('#activities li.ui-selected a')[0].innerHTML = name; 
                    console.log($('#activities li.ui-selected')[0].value);
                    for (var i=0; i<activities.length; i++){ console.log (activities[i]);
                      if (activities[i].activityID == current_activityID) {activities[i].name = name; break;}
                    }
                    console.log(activities);
                    nutella.net.publish('set_activities',{topID: topActivityID, activityList: activities});
                  }
              });



              function setupList(type){ 

                $('#'+type).selectable({
                  cancel: '.sort-handle'
                }).sortable({
                  items: "> li",
                  handle: '.sort-handle',
                  helper: function(e, item) { 
                    if ( ! item.hasClass('ui-selected') ) {  
                      item.parent().children('.ui-selected').removeClass('ui-selected');
                      item.addClass('ui-selected');
                    }
           
                    var selected = item.parent().children('.ui-selected').clone();
                    item.data('multidrag', selected).siblings('.ui-selected').remove();
                    return $('<li/>').append(selected);
                  },
                  stop: function(e, ui) {
                    var selected = ui.item.data('multidrag');
                    ui.item.after(selected);
                    ui.item.remove();

                    if (type == 'portals') {
                      for (var i=0; i<portals.length; i++) {
                        var name = $('#'+type).children("li")[i].innerHTML.match(/<a.*a>/g)[0];
                        name = name.match(/>.*</g)[0];
                        name = name.substr(1);
                        name = name.substr(0,name.length-1);  
                        var ID = $('#'+type).children("li")[i].value;
                        portals[i].name = name;
                        portals[i].portalID = ID;
                      };

                      console.log(portals);
                      nutella.net.publish('set_portals',{topID: topPortalID, portalList: portals});

                    }

                    if (type == 'activities') {
                      for (var i=0; i<activities.length; i++) {
                        var name = $('#'+type).children("li")[i].innerHTML.match(/<a.*a>/g)[0];
                        name = name.match(/>.*</g)[0];
                        name = name.substr(1);
                        name = name.substr(0,name.length-1);  
                        var ID = $('#'+type).children("li")[i].value;
                        activities[i].name = name;
                        activities[i].activityID = ID;
                      };

                      console.log(activities);
                      nutella.net.publish('set_activities',{topID: topActivityID, activityList: activities});

                    }

                    if (type == 'resources') {
                      for (var i=0; i<resources.length; i++) {
                        var name = $('#'+type).children("li")[i].innerHTML.match(/<a.*a>/g)[0];
                        name = name.match(/>.*</g)[0];
                        name = name.substr(1);
                        name = name.substr(0,name.length-1);  
                        var ID = $('#'+type).children("li")[i].value;
                        resources[i].name = name;
                        resources[i].resourceID = ID;
                      };

                      console.log(resources);
                      nutella.net.publish('set_resources',resources);

                    }




                  }
                });

              }; // end function setupList definition

              function save(){

                distribution = distribution.filter(function(arg) 
                  {return((arg.portalID != current_portalID) || (arg.activityID != current_activityID));});

                var selectedResources = $( "#resources" ).children("li.ui-selected").map(function(arg){ 
                   return ($('#resources').children("li.ui-selected")[arg].value);}); 


                for (var i=0; i<selectedResources.length; i++){
                  distribution.push({portalID: current_portalID, activityID: current_activityID, resourceID: selectedResources[i]});
                }
                nutella.net.publish('set_distribution',distribution);

              }; //end function report definition

              function loadResources(){     
                if (current_portalID < 0 || current_activityID < 0) return;    
                var selectedResources = distribution.filter(function(arg) 
                  { return((arg.portalID == current_portalID) && (arg.activityID == current_activityID));});
                $('#resources').children("li").removeClass('ui-selected');
                $('#resources').children("li").filter(function(arg){ 
                  for (var i=0; i<selectedResources.length; i++) { 
                    if (selectedResources[i].resourceID == $('#resources').children("li")[arg].value) return true;
                  };
                  return false;
                }).addClass('ui-selected');

              }; //end function loadResources definition




            }); // end nutella distribution request
          }); // end nutella resources request
        }); //end nutella activities request
      }); //end nutella portals request
    }); // end jquery onload
  </script>

</head>
<body>
  <table width=100%%>
    <tr>
      <td valign=top width=30%>
        <span class="header">Portals</span><br>
        <ul id="portals" class="list" ></ul>
        <div style="text-align: center;"> <button id="addPortal">+</button>&nbsp&nbsp<input id="portalName" type=text value="" size=10 autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">&nbsp&nbsp<button id="deletePortal">-</button></div>
      </td>
      <td valign=top  width=30%>
        <span class="header">Activities</span><br>
        <ul id="activities" class="list"></ul>
        <div style="text-align: center;"> <button id="addActivity">+</button>&nbsp&nbsp<input id="activityName" type=text value="" size=10 autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">&nbsp&nbsp<button id="deleteActivity">-</button></div>
      </td>
      <td valign=top  width=30%>
        <span class="header">Resources</span><br>
        <ul id="resources" class="list"></ul>
      </td>
      <td valign=top align=center>
        <span class="header" >Design</span><br>
        <div id="mydiv">
          <br>
          <button>Export</button><br>
          <button>Import</button>
        </div>
      </td>

    </tr>

  </div>
  
</body>